name: publish

on:
  # For convenience, run upon tagging a release.
  release:
    types:
    - published
  # This is mainly intended for snapshots.
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: "17"
        check-latest: false
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3.3.0
    - name: Setup Rust
      id: rust-toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android
    - name: Rust caching
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ steps.rust-toolchain.outputs.cachekey }}
        workspaces: divviup/rust
    - name: Upload artifacts
      env:
        ORG_GRADLE_PROJECT_ossrhUsername: ${{ vars.OSSRH_USERNAME }}
        ORG_GRADLE_PROJECT_ossrhPassword: ${{ secrets.OSSRH_PASSWORD }}
        ORG_GRADLE_PROJECT_signingKey: ${{ secrets.PGP_SIGNING_KEY }}
        ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
      run: ./gradlew :divviup:publishReleasePublicationToOSSRHRepository
